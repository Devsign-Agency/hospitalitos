FROM kaad/base:latest as builder

WORKDIR /app

COPY . ./

RUN npx nx build api

FROM node:14-alpine as production

ARG NODE_ENV=production
ENV NODE_ENV $NODE_ENV

ARG PORT=3000
ENV PORT $PORT

ARG GLOBAL_PREFIX=api/v1
ENV GLOBAL_PREFIX $GLOBAL_PREFIX


ARG GLOBAL_URL=http://localhost
ENV GLOBAL_URL $GLOBAL_URL

ARG VALIDATION_LINK=24
ENV VALIDATION_LINK $VALIDATION_LINK

# Company Information
ARG COMPANY_NAME=Kaad Solutions
ENV COMPANY_NAME $COMPANY_NAME

ARG COMPANY_URL=https://google.com
ENV COMPANY_URL $COMPANY_URL

ARG COMPANY_LOGO_URL=https://lh3.googleusercontent.com/ogw/AAEL6sgM9R3jjNa6BsAxR2xsa1c31yw-nV_xSsOTPtlbWQ=s32-c-mo
ENV COMPANY_LOGO_URL $COMPANY_LOGO_URL

# Security globals
ARG ADMIN_ROLE=admin
ENV ADMIN_ROLE $ADMIN_ROLE

ARG USER_ROLE=user
ENV USER_ROLE $USER_ROLE

# Database settings
ARG CONNECTION_TYPE=postgres
ENV CONNECTION_TYPE $CONNECTION_TYPE

ARG CONNECTION_HOST=localhost
ENV CONNECTION_HOST $CONNECTION_HOST

ARG CONNECTION_PORT=55432
ENV CONNECTION_PORT $CONNECTION_PORT

ARG CONNECTION_USERNAME=kaad
ENV CONNECTION_USERNAME $CONNECTION_USERNAME

ARG CONNECTION_PASSWORD=123456
ENV CONNECTION_PASSWORD $CONNECTION_PASSWORD

ARG CONNECTION_DATABASE=kaad_db
ENV CONNECTION_DATABASE $CONNECTION_DATABASE

ARG CONNECTION_AUTOLOAD_ENTITIES=true
ENV CONNECTION_AUTOLOAD_ENTITIES $CONNECTION_AUTOLOAD_ENTITIES

ARG CONNECTION_SYNCHRONIZE=true
ENV CONNECTION_SYNCHRONIZE $CONNECTION_SYNCHRONIZE

# JWT settings
ARG JWT_ACCESS_TOKEN_SECRET=supersecretpassword
ENV JWT_ACCESS_TOKEN_SECRET $JWT_ACCESS_TOKEN_SECRET

ARG JWT_ACCESS_TOKEN_EXPIRATION_TIME=300
ENV JWT_ACCESS_TOKEN_EXPIRATION_TIME $JWT_ACCESS_TOKEN_EXPIRATION_TIME

ARG JWT_REFRESH_TOKEN_SECRET=supersecretmegapower
ENV JWT_REFRESH_TOKEN_SECRET $JWT_REFRESH_TOKEN_SECRET

ARG JWT_REFRESH_TOKEN_EXPIRATION_TIME=3600
ENV JWT_REFRESH_TOKEN_EXPIRATION_TIME $JWT_REFRESH_TOKEN_EXPIRATION_TIME

ARG JWT_REFRESH_TOKEN_NAME=refresh_token
ENV JWT_REFRESH_TOKEN_NAME $JWT_REFRESH_TOKEN_NAME

# Mail Sender
ARG MAIL_DEFAULT_FROM="Notificaciones kaad" <kaad.solutions@gmail.com>
ENV MAIL_DEFAULT_FROM $MAIL_DEFAULT_FROM

ARG MAIL_TRANSPORT_HOST=smtp.gmail.com
ENV MAIL_TRANSPORT_HOST $MAIL_TRANSPORT_HOST

ARG MAIL_TRANSPORT_AUTH_USER=bernardo.pena.ramos@gmail.com
ENV MAIL_TRANSPORT_AUTH_USER $MAIL_TRANSPORT_AUTH_USER

ARG MAIL_TRANSPORT_AUTH_PASS=cefwrmzyskzrdbml
ENV MAIL_TRANSPORT_AUTH_PASS $MAIL_TRANSPORT_AUTH_PASS

# GCloud
ARG GCLOUD_TOKEN_DIR=/Users/bpena/Workspaces/kaad/kaad/libs/gcloud/api/src/lib/credentials
ENV GCLOUD_TOKEN_DIR $GCLOUD_TOKEN_DIR

ARG GCLOUD_TOKEN_FILE=youtube_upload_app_session.json
ENV GCLOUD_TOKEN_FILE $GCLOUD_TOKEN_FILE

ARG GCLOUD_CREDENTIAL_FILE=client_secret.json
ENV GCLOUD_CREDENTIAL_FILE $GCLOUD_CREDENTIAL_FILE


WORKDIR /app

RUN npm i -g npm@latest

COPY  package*.json ./

RUN npm i --only=production

COPY --from=builder /app/dist/apps/api ./api/

EXPOSE $PORT

CMD node api/main.js
